import streamlit as st
import pandas as pd
import os
from datetime import datetime

st.set_page_config(page_title="MealMatch üçΩÔ∏è", layout="centered")
st.title("üçΩÔ∏è MealMatch - ‡∏°‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏î‡∏µ?")

# Session state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° flow
if "submitted" not in st.session_state:
    st.session_state.submitted = False
if "selected_feedback" not in st.session_state:
    st.session_state.selected_feedback = None

# === ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ===
data = {
    "name": ["‡∏£‡πâ‡∏≤‡∏ô A", "‡∏£‡πâ‡∏≤‡∏ô B", "‡∏£‡πâ‡∏≤‡∏ô C", "‡∏£‡πâ‡∏≤‡∏ô D", "‡∏£‡πâ‡∏≤‡∏ô E", "‡∏£‡πâ‡∏≤‡∏ô F"],
    "location": ["‡∏õ‡∏£‡∏∞‡∏ï‡∏π 1", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 1", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 3", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 4", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 1", "‡∏õ‡∏£‡∏∞‡∏ï‡∏π 2"],
    "choice": ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß", "‡∏õ‡∏¥‡πâ‡∏á‡∏¢‡πà‡∏≤‡∏á", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô"],
    "budget": ["50 - 100", "50 - 100", "50 - 100", "200+", "100 - 200", "50 - 100"],
    "time": ["‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "‡πÄ‡∏ä‡πâ‡∏≤", "‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "‡πÄ‡∏¢‡πá‡∏ô", "‡πÄ‡∏ä‡πâ‡∏≤"]
}
df = pd.DataFrame(data)

# === ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° ===
if not st.session_state.submitted:
    with st.form("user_form"):
        user_location = st.selectbox("üìç ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡πÑ‡∏õ", df["location"].unique())
        user_choice = st.selectbox("üç± ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£", df["choice"].unique())
        user_budget = st.radio("üí∏ ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏°‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó)", df["budget"].unique())
        user_time = st.selectbox("‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡∏¥‡∏ô", df["time"].unique())

        submitted = st.form_submit_button("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£")
        if submitted:
            st.session_state.submitted = True
            st.session_state.user_inputs = {
                "location": user_location,
                "choice": user_choice,
                "budget": user_budget,
                "time": user_time
            }

# === ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° ===
if st.session_state.submitted:
    user_inputs = st.session_state.user_inputs
    filtered = df[
        (df["location"] == user_inputs["location"]) &
        (df["choice"] == user_inputs["choice"]) &
        (df["budget"] == user_inputs["budget"]) &
        (df["time"] == user_inputs["time"])
    ]

    matched_restaurants = filtered["name"].tolist()

    if matched_restaurants:
        st.success("‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ üçú")
        selected = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏ô‡πÉ‡∏à:", matched_restaurants)

        if selected:
            st.session_state.selected_feedback = selected
            st.info(f"‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô: {selected} ‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å!")

            # === ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å feedback ===
            feedback = {
                "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "location": user_inputs["location"],
                "choice": user_inputs["choice"],
                "budget": user_inputs["budget"],
                "time": user_inputs["time"],
                "selected": selected
            }

            feedback_df = pd.DataFrame([feedback])
            if os.path.exists("user_feedback.csv"):
                feedback_df.to_csv("user_feedback.csv", mode="a", header=False, index=False)
            else:
                feedback_df.to_csv("user_feedback.csv", index=False)

            # === ‡πÅ‡∏™‡∏î‡∏á Feedback ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ===
            if os.path.exists("user_feedback.csv"):
                st.markdown("---")
                st.markdown("### üìù ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤")
                all_feedback = pd.read_csv("user_feedback.csv")
                st.dataframe(all_feedback)
                st.info(f"üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°: {len(all_feedback)} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á")

                with st.expander("üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)"):
                    admin_password = st.text_input("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
                    if admin_password == "your_secret_code":  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                        if st.button("üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"):
                            os.remove("user_feedback.csv")
                            st.warning("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚ùå")
                            st.rerun()
                    elif admin_password:
                        st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚ùå")

            # ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà
            st.markdown("---")
            if st.button("üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà"):
                st.session_state.submitted = False
                st.session_state.selected_feedback = None
                st.rerun()

    else:
        st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üò• ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏ô‡∏∞")
        if st.button("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÉ‡∏à"):
            st.session_state.selected_feedback = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÉ‡∏à"
            st.warning("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ üôè")
            st.markdown("---")
            if st.button("üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà"):
                st.session_state.submitted = False
                st.session_state.selected_feedback = None
                st.rerun()
